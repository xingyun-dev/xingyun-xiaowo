{% extends "/xingyun-notebook/base.html" %}   {#将当前页面继承至base.html母版#}
{% block content %}
<div class="container" style="margin-top: 20px;">
    <div class="row">

        <!-- 中部区域布局 -->
        <div class="container" style="margin-top: 10px;">
            <div class="row">
                <div class="col-sm-2 col-12" style="padding: 0px 5px; ">
                    <div class="col-12 admin-side">
                        <!-- 绘制左侧菜单栏并添加正确的超链接 -->
                        <ul>
                            <li><a href="/admin"><span aria-hidden="true"></span>&nbsp;&nbsp;文章管理</a>
                            </li>
                            <li><a href="/admin-tools"><span aria-hidden="true"></span>&nbsp;&nbsp;工具管理</a></li>

                            <li><a href="/admin-user"><span aria-hidden="true"></span>&nbsp;&nbsp;用户管理</a></li>
                            <li><a href="/admin-home"><span aria-hidden="true"></span>&nbsp;&nbsp;后台首页</a></li>
                        </ul>
                    </div>
                </div>

                <div class="col-sm-10 col-12" style="padding: 0px 10px">
                    <div class="col-12 admin-main">
                        <!--搜索栏-->
                        <div class="col-12 search-bar row">
                            <div class="col-2">
                                <select id="category" class="form-control" onchange="doSearch()">
                                    <option value="" style="display: none">请选择分类</option>
                                    <option value="all">全部分类</option>
                                    {% for key, value in article_type.items() %}
                                    <option value="{{ key }}">{{ value }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-3">
                                <input type="text" class="form-control" id="keyword" placeholder="搜索文章"
                                       onkeyup="doSearchBykeyword(event)">
                            </div>
                            <div class="col-2" style="text-align:left;">
                                <button type="button" class="btn btn-dark" onclick="doSearchBykeyword(null)">搜索
                                </button>
                            </div>


                            <div class="col-3">
                                <input type="text" class="form-control" id="keyeditor" placeholder="查询作者"
                                       onkeyup="doSearchBymingzi(event)">
                            </div>
                            <div class="col-2" style="text-align:left;">
                                <button type="button" class="btn btn-danger" onclick="doSearchBymingzi(null)">查询
                                </button>
                            </div>

                        </div>
                        <div class="col-12" style="padding: 10px;">
                            <table class="table col-12">
                                <thead style="font-weight: bold">
                                <tr>
                                    <td width="7%" align="center">编号</td>
                                    <td width="25%">标题</td>
                                    <td width="20%" align="center">作者</td>
                                    <td width="9%" align="center">类型</td>
                                    <td width="7%" align="center">浏览</td>
                                    <td width="7%" align="center">评论</td>
                                    <td width="25%" align="center">操作</td>
                                </tr>
                                </thead>
                                <tbody>
                                {%for article,nickname in result%}
                                <tr>
                                    <td align="center">{{article.articleid}}</td>
                                    <td>
                                        <a href="/notebook/{{is_markdown(article.articleid)}}/{{article.articleid}}">
                                            {{article.headline}}
                                        </a>
                                    </td>
                                    <td align="center"> <a href="/xingshixiaowo/{{nickname}}/home" >{{nickname}}</a></td>

                                    <!--                                    <td align="center">{{article.category}}</td>-->
                                    <td align="center">{{article_type[article.category | string]}}</td>
                                    <td align="center">{{article.readcount}}</td>
                                    <td align="center">{{article.replycount}}</td>
                                    <td align="center">
                                        <!--                                        <button id="hide-{{article.articleid}}"-->
                                        <!--                                                onclick="toggleHide(this,'{{article.articleid}}')">隐藏-->
                                        <!--                                        </button>-->
                                        <button class="btn btn-hidden btn-success"
                                                data-articleid="{{ article.articleid }}">

                                        </button>


                                        <!--                                        <button id="recommend-{{article.articleid}}"-->
                                        <!--                                                onclick="toggleRecommend(this,'{{article.articleid}}')">推荐-->
                                        <!--                                        </button>-->
                                        <button class="btn btn-recommend btn-dark"
                                                data-articleid="{{ article.articleid }}">

                                        </button>
                                        <!--                                        <button id="check-{{article.articleid}}"-->
                                        <!--                                                onclick="toggleCheck(this,'{{article.articleid}}')">待审-->
                                        <!--                                        </button>-->
                                        <button class="btn btn-checked btn-danger"
                                                data-articleid="{{ article.articleid }}">

                                        </button>
                                        <button class="btn-delete btn-danger btn"
                                                data-articleid="{{ article.articleid }}">
                                            删除
                                        </button>

                                    </td>
                                </tr>
                                {%endfor%}
                                </tbody>
                            </table>
                        </div>

                        <!-- 分页导航栏 -->
                        <div class="col-12 paginate">
                            {% if page==1%}
                            <!-- 如果是第1页，则上一页也是第1页，否则上一页为当前页-1 -->
                            <a href="/admin/article/1">上一页</a>&nbsp;&nbsp;
                            {% else %}
                            <a href="/admin/article/{{page-1}}">上一页</a>&nbsp;&nbsp;
                            {% endif %}

                            <!-- 根据总页数循环填充页码，并为其添加超链接进行导航 -->
                            {% for i in range(total) %}
                            <a href="/admin/article/{{i+1}}">{{i+1}}</a>&nbsp;&nbsp;
                            {% endfor %}

                            {% if page==total%}
                            <!-- 如果是最后一页，则下一页也是最后页，否则下一页为当前页+1 -->
                            <a href="/admin/article/{{total}}">下一页</a>
                            {% else %}
                            <a href="/admin/article/{{page+1}}">下一页</a>
                            {% endif %}

                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- 对应的函数的代码 -->
        <script type="text/javascript">

            // 分类搜索
            function doSearch(event) {
                if (event != null && event.keyCode !== 13) {
                    return false;
                }
                var category = $.trim($("#category").val());
                if (category === "all") {  // 当选择项为"全部分类"时
                    location.href = "/admin";  // 跳转到 "/admin" 页面
                } else {
                    location.href = "/admin/type/" + category + "--1";  // 其他选项跳转到相应的链接地址
                }
            }

            // 关键字搜索
            function doSearchBykeyword(event) {
                if (event != null && event.keyCode != 13) {
                    return false;
                }

                var keyword = $.trim($("#keyword").val());
                if (keyword.length == 0 || keyword.length > 10 || keyword.indexOf('%') >= 0) {
                    bootbox.alert({'title': '错误提示！', 'message': "您输入的关键字不合理"});
                    $("#keyword").focus();
                    return false;
                }
                location.href = "/admin/search/" + keyword;

            }

            // 作者查询
            function doSearchBymingzi(event) {
                if (event != null && event.keyCode != 13) {
                    return false;
                }

                var keyword = $.trim($("#keyeditor").val());
                if (keyword.length == 0 || keyword.length > 10 || keyword.indexOf('%') >= 0) {
                    bootbox.alert({'title': '错误提示！', 'message': "您输入的查询名字未找到"});
                    $("#keyword").focus();
                    return false;
                }
                location.href = "/admin/search_mingzi/" + keyword;

            }


            // // 文章隐藏切换
            // function toggleHide(obj, articleid) {
            //     $.get('/admin/article/hide/' + articleid, function (data) {
            //         if (data == '1') {
            //             $(obj).html('<span style="color: red">取消隐藏</span>');
            //             bootbox.alert({title: "信息提示", message: "文章隐藏成功！"});
            //         } else if (data == '0') {
            //             $(obj).html('<span>隐藏</span>');
            //         }
            //     });
            // };
            //
            // $(document).ready(function () {
            //     // 在页面加载完成后执行的代码
            //     $('#hide').each(function () {
            //         var onclick = $(this).attr('onclick');
            //         var articleid = onclick.substring(onclick.indexOf('(') + 1, onclick.indexOf(')'));
            //         toggleHide(this, articleid);
            //     });
            // });


            //隐藏切换
            $(function () {
                $('.btn-hidden').each(function () {
                    var articleId = $(this).data('articleid');
                    var $hideBtn = $(this); // 保存隐藏按钮元素

                    // 检查本地存储中是否有对应文章ID的状态
                    var isHidden = localStorage.getItem('article_' + articleId);
                    if (isHidden === 'true') {
                        $hideBtn.text('取消隐藏');
                    } else {
                        $hideBtn.text('隐藏');
                    }

                    $hideBtn.click(function () {
                        bootbox.confirm({
                            title: "信息提示",
                            message: "您确定要进行此操作吗？",
                            buttons: {
                                confirm: {
                                    label: '确认',
                                    className: 'btn-success'
                                },
                                cancel: {
                                    label: '取消',
                                    className: 'btn-danger'
                                }
                            },
                            callback: function (result) {
                                if (result) {
                                    $.ajax({
                                        url: '/article/hidden',
                                        type: 'POST',
                                        data: {articleid: articleId},
                                        success: function (data) {
                                            if (data === 'hidden-success') {
                                                // 更新文章状态为已隐藏
                                                localStorage.setItem('article_' + articleId, 'true');
                                                // $hideBtn.text('已隐藏');
                                                bootbox.alert({
                                                    title: "隐藏",
                                                    message: "文章隐藏成功.",
                                                    callback: function () {
                                                        location.reload();
                                                    }
                                                }).find('.modal-dialog').addClass('success-dialog');
                                            } else if (data === "hidden-cancel") {
                                                // 更新文章状态为隐藏
                                                localStorage.setItem('article_' + articleId, 'false');
                                                // $hideBtn.text('隐藏');
                                                bootbox.alert({
                                                    title: "取消隐藏",
                                                    message: "文章取消隐藏成功.",
                                                    callback: function () {
                                                        location.reload();
                                                    }
                                                }).find('.modal-dialog').addClass('success-dialog');
                                            }
                                        },
                                        error: function (xhr, textStatus, errorThrown) {
                                            bootbox.alert({title: "错误提示", message: "隐藏失败，请重试！"});
                                        }
                                    });
                                }
                            }
                        });
                    });
                });
            });


            // 文章推荐切换
            // function toggleRecommend(obj, articleid) {
            //     $.get('/admin/article/recommend/' + articleid, function (data) {
            //         if (data == '1') {
            //             $(obj).html('<span style="color: red">取消推荐</span>');
            //             bootbox.alert({title: "信息提示", message: "文章推荐成功！"});
            //         } else if (data == '0') {
            //             $(obj).html('<span>推荐</span>');
            //         }
            //     });
            // };
            //
            // $(document).ready(function () {
            //     // 在页面加载完成后执行的代码
            //     $('#recommend').each(function () {
            //         var onclick = $(this).attr('onclick');
            //         var articleid = onclick.substring(onclick.indexOf('(') + 1, onclick.indexOf(')'));
            //         toggleRecommend(this, articleid);
            //     });
            // });

            // 推荐切换
            $(function () {
                $('.btn-recommend').each(function () {
                    var articleId = $(this).data('articleid');
                    var $recommendBtn = $(this); // 保存推荐按钮元素

                    // 检查本地存储中是否有对应文章ID的状态
                    var isRecommend = localStorage.getItem('article_' + articleId + '_recommend');
                    if (isRecommend === 'true') {
                        $recommendBtn.text('取消推荐');
                    } else {
                        $recommendBtn.text('推荐');
                    }

                    $recommendBtn.click(function () {
                        bootbox.confirm({
                            title: "信息提示",
                            message: "您确定要进行此操作吗？",
                            buttons: {
                                confirm: {
                                    label: '确认',
                                    className: 'btn-success'
                                },
                                cancel: {
                                    label: '取消',
                                    className: 'btn-danger'
                                }
                            },
                            callback: function (result) {
                                if (result) {
                                    $.ajax({
                                        url: '/article/recommend',
                                        type: 'POST',
                                        data: {articleid: articleId},
                                        success: function (data) {
                                            if (data === 'recommend-success') {
                                                // 更新文章状态为已推荐
                                                localStorage.setItem('article_' + articleId + '_recommend', 'true');
                                                bootbox.alert({
                                                    title: "推荐",
                                                    message: "文章推荐成功.",
                                                    callback: function () {
                                                        location.reload();
                                                    }
                                                }).find('.modal-dialog').addClass('success-dialog');
                                            } else if (data === "recommend-cancel") {
                                                // 更新文章状态为取消推荐
                                                localStorage.setItem('article_' + articleId + '_recommend', 'false');
                                                bootbox.alert({
                                                    title: "取消推荐",
                                                    message: "文章取消推荐成功.",
                                                    callback: function () {
                                                        location.reload();
                                                    }
                                                }).find('.modal-dialog').addClass('success-dialog');
                                            }
                                        },
                                        error: function (xhr, textStatus, errorThrown) {
                                            bootbox.alert({title: "错误提示", message: "推荐失败，请重试！"});
                                        }
                                    });
                                }
                            }
                        });
                    });
                });
            });


            // 文章审核切换
            // function toggleCheck(obj, articleid) {
            //     $.get('/admin/article/check/' + articleid, function (data) {
            //         if (data == '1') {
            //             $(obj).html('<span style="color: red">已审核</span>');
            //             bootbox.alert({title: "信息提示", message: "文章审核成功！"});
            //         } else if (data == '0') {
            //             $(obj).html('<span>待审</span>');
            //         }
            //     });
            // };
            //
            // $(document).ready(function () {
            //     // 在页面加载完成后执行的代码
            //     $('#check').each(function () {
            //         var onclick = $(this).attr('onclick');
            //         var articleid = onclick.substring(onclick.indexOf('(') + 1, onclick.indexOf(')'));
            //         toggleCheck(this, articleid);
            //     });
            // });

            // 审核切换
            $(function () {
                $('.btn-checked').each(function () {
                    var articleId = $(this).data('articleid');
                    var $checkedBtn = $(this); // 保存审核按钮元素

                    // 检查本地存储中是否有对应文章ID的状态
                    var isChecked = localStorage.getItem('article_' + articleId + '_checked');
                    if (isChecked === 'true') {
                        $checkedBtn.text('已审核');
                    }  else if (isChecked === null) {
                        $checkedBtn.text('已审核');
                    }
                    else if (isChecked === 'false') {
                        $checkedBtn.text('待审');
                    }

                    $checkedBtn.click(function () {
                        bootbox.confirm({
                            title: "信息提示",
                            message: "您确定要进行此操作吗？",
                            buttons: {
                                confirm: {
                                    label: '确认',
                                    className: 'btn-success'
                                },
                                cancel: {
                                    label: '取消',
                                    className: 'btn-danger'
                                }
                            },
                            callback: function (result) {
                                if (result) {
                                    $.ajax({
                                        url: '/article/checked',
                                        type: 'POST',
                                        data: {articleid: articleId},
                                        success: function (data) {
                                            if (data === 'checked-success') {
                                                // 更新文章状态为已审核
                                                localStorage.setItem('article_' + articleId + '_checked', 'true');
                                                bootbox.alert({
                                                    title: "审核",
                                                    message: "文章审核成功.",
                                                    callback: function () {
                                                        location.reload();
                                                    }
                                                }).find('.modal-dialog').addClass('success-dialog');
                                            } else if (data === "checked-cancel") {
                                                // 更新文章状态为待审核
                                                localStorage.setItem('article_' + articleId + '_checked', 'false');
                                                bootbox.alert({
                                                    title: "审核不通过",
                                                    message: "文章审核不通过.",
                                                    callback: function () {
                                                        location.reload();
                                                    }
                                                }).find('.modal-dialog').addClass('success-dialog');
                                            }
                                        },
                                        error: function (xhr, textStatus, errorThrown) {
                                            bootbox.alert({title: "错误提示", message: "审核失败，请重试！"});
                                        }
                                    });
                                }
                            }
                        });
                    });
                });
            });


            //删除文章
            $(function () {
                $('.btn-delete').click(function () {
                    var articleId = $(this).data('articleid');
                    bootbox.confirm({
                        title: "删除文章",
                        message: "您确定要删除这篇文章吗？",
                        buttons: {
                            confirm: {
                                label: '确认',
                                className: 'btn-success'
                            },
                            cancel: {
                                label: '取消',
                                className: 'btn-danger'
                            }
                        },
                        callback: function (result) {
                            if (result) {
                                $.ajax({
                                    url: '/article/delete',
                                    type: 'POST',
                                    data: {articleid: articleId},
                                    success: function (data) {
                                        if (data === 'delete-success') {
                                            bootbox.alert({
                                                title: "信息提示",
                                                message: "文章删除成功.",
                                                callback: function () {
                                                    location.reload();
                                                }
                                            }).find('.modal-dialog').addClass('success-dialog');
                                        } else {
                                            bootbox.alert({title: "错误提示", message: "删除失败，请重试！"});
                                        }
                                    },
                                    error: function (xhr, textStatus, errorThrown) {
                                        bootbox.alert({title: "错误提示", message: "删除失败，请重试！"});
                                    }
                                });
                            }
                        }
                    });
                });
            });


        </script>

    </div>
</div>

{% endblock %}