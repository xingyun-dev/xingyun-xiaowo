{% extends "/xingyun-notebook/base.html" %}   {#å°†å½“å‰é¡µé¢ç»§æ‰¿è‡³base.htmlæ¯ç‰ˆ#}
{% block content %}

<div class="col-sm-9 col-12" id="left" style="padding-right: 0px">
    <div class="col-12 row article-detail">
        <div class="col-9 title">
            {{article.headline}}
        </div>
        <div class="col-3 favorite">
            {% if is_favorited==True %}
            <label class="favorite-btn" onclick="cancelFavorite('{{article.articleid}}')"><span
                    aria-hidden="true"></span>å–æ¶ˆæ”¶è—</label>
            {% else %}
            <label class="favorite-btn" onclick="addFavorite('{{article.articleid}}')"><span
                    aria-hidden="true"></span>æ”¶è—æœ¬æ–‡</label>
            {% endif %}

        </div>
     <div class="col-12 info "style="display:flex">
            <a href="/home/{{user_info.userid}}" target="_blank">
        {{article.nickname}}&nbsp;
                </a>
            &nbsp;&nbsp;{{article_type[article.category | string]}}&nbsp;&nbsp;&nbsp;
             <span class="hide_time">
            æ—¥æœŸï¼š{{article.createtime}}&nbsp;&nbsp;&nbsp;
         </span>
            é˜…è¯»ï¼š{{article.readcount}} æ¬¡&nbsp;&nbsp;&nbsp;
             <div style="margin-left: auto; display: flex ">

                          <button class="btn-xiaowo follow Following btn-follow"  data-followed-vip-id="{{ user_info.userid }}"
                                style=" background:none; margin-bottom: 10px;border: none;color: #0d8ddb">
                            å…³æ³¨ä½œè€…
                        </button>
                    </div>
        </div>

        <div id="text_editormd" style="margin-top: 20px">
            <textarea style="display:none;" placeholder="markdownè¯­è¨€">{{ article.content }}</textarea>
        </div>


        <link rel="stylesheet" href="/lib/css/editormd.css"/>
        <script src="/lib/lib/marked.min.js"></script>
        <script src="/lib/lib/prettify.min.js"></script>
<!--        <script src="/lib/lib/raphael.min.js"></script>-->
        <script src="/lib/lib/underscore.min.js"></script>
        <script src="/lib/lib/sequence-diagram.min.js"></script>
        <script src="/lib/lib/flowchart.min.js"></script>
        <script src="/lib/lib/jquery.flowchart.min.js"></script>
        <script src="/lib/editormd.js"></script>

        <script type="text/javascript">
            var textEditor;
            $(function () {
                textEditor = editormd.markdownToHTML("text_editormd", {
                    width: "100%",
                    height: "1040px",
                    syncScrolling: "single",
                    path: "/lib/lib/",
                    preview: true,
                    watch: true,
                    editor: false,

                });
            });
        </script>


    </div>

    <div class="col-12 row  article-nav">
        <div  class="hide_link">æ˜Ÿäº‘ç¬”è®°: https://www.whtuu.cn/notebook/{{is_markdown(article.articleid)}}/{{article.articleid}}</div>
        <div>
            <a href="/notebook/{{is_markdown(prev_next.prev_id)}}/{{prev_next.prev_id}}">ä¸Šä¸€ç¯‡ï¼š{{prev_next.prev_headline}}</a>
        </div>
        <div>
            <a href="/notebook/{{is_markdown(prev_next.next_id)}}/{{prev_next.next_id}}">ä¸‹ä¸€ç¯‡ï¼š{{prev_next.next_headline}}</a>
        </div>
    </div>

    <!--è¯„è®º-->
    <div class="col-12 article-comment" style="margin-left: -12px">
        <div class="col-12 row">
            <div class="col-2">
                <label for="nickname" style="margin-left: 30px; font-weight: bold" class="hide_nickname">ä½ çš„æ˜µç§°ï¼š</label>
            </div>
            <div class="col-10">
                {% if session.get('islogin')=='true'%}
                <input type="text" class="form-control" id="nickname" value="{{session.get('nickname')}}" readonly/>
                {% else %}
                <input type="text" class="form-control" id="nickname" value="ä½ è¿˜æœªç™»å½•,åŒå‡»æ­¤å¤„å¯ç™»å½•."
                       ondblclick="showLogin()" readonly/>
                {% endif %}
            </div>
        </div>
        <div class="col-12 row">
            <div class="col-2">
                <label for="comment" style="margin-left: 30px; font-weight: bold" class="hide_comment">ä½ çš„è¯„è®ºï¼š</label>
            </div>
            <div class="col-10">
                        <textarea class="form-control" style="height: 120px;" id="comment"
                                  placeholder="è¯·è¾“å…¥ä½ çš„è¯„è®º"></textarea>
            </div>
        </div>
        <div class="col-12 row">
            <div class="col-12" style="text-align:right;">
                {% if session.get('islogin')=='true'%}
                <button class="btn btn-primary" onclick="addComment('{{article.articleid}}')" id="submitBtn">å‘è¡¨è¯„è®º
                </button>
                <button class="btn btn-primary" type="button" onclick="replyComment('{{article.articleid}}')"
                        id="replyBtn" style="display: none;">å›å¤è¯„è®º
                </button>
                {% else %}
                <button class="btn btn-primary" onclick="showLogin()">ç‚¹æ­¤ç™»å½•</button>
                {% endif %}
            </div>
        </div>


        <div id="commentDIV"></div>


        <!--ç”±äºä½¿ç”¨Ajaxè¿›è¡Œåˆ†é¡µ,åˆ†é¡µå¯¼èˆªæ—¶ä¸èƒ½å†ä½¿ç”¨è¶…é“¾æ¥ -->
        {% if total>1 %}
        <div class="col-12 paginate">
            <label onclick="gotoPage('{{article.articleid}}','prev')">ä¸Šä¸€é¡µ</label>&nbsp;&nbsp;

            {% for i in range(total) %}
            <label onclick="gotoPage('{{article.articleid}}','{{i+1}}')">{{i+1}}</label>&nbsp;&nbsp;
            {% endfor %}

            <label onclick="gotoPage('{{article.articleid}}','next')">ä¸‹ä¸€é¡µ</label>

        </div>
        {% endif %}
    </div>
</div>

{% include "/xingyun-notebook/side-jquery.html" %}
<script>


    // æ·»åŠ æ”¶è—
    function addFavorite(articleid) {
        var param = 'articleid=' + articleid;
        $.post('/favorite', param, function (data) {
            if (data == 'not-login') {
                bootbox.alert({title: "é”™è¯¯æç¤º", message: "ä½ è¿˜æœªç™»å½•,è¯·å…ˆç™»å½•åå†æ”¶è—æœ¬æ–‡"});
                // alert('ä½ è¿˜æœªç™»å½•,è¯·å…ˆç™»å½•åå†æ”¶è—æœ¬æ–‡')
            } else if (data == 'favorite-pass') {
                bootbox.alert({title: "ä¿¡æ¯æç¤º", message: "æ–‡ç« æ”¶è—æˆåŠŸ,å¯åœ¨æˆ‘çš„æ”¶è—ä¸­æŸ¥çœ‹"});
                // alert('æ–‡ç« æ”¶è—æˆåŠŸ,å¯åœ¨æˆ‘çš„æ”¶è—ä¸­æŸ¥çœ‹')
                //èœå•åç§°ä¿®æ”¹ä¸ºï¼šæ„Ÿè°¢æ”¶è—
                $(".favorite-btn").html('<span  aria-hidden="true" ></span>æ„Ÿè°¢æ”¶è—');
                //å–æ¶ˆæ”¶è—æŒ‰é’®çš„å•å‡»äº‹ä»¶
                $(".favorite-btn").attr('onclick', '').unbind('click');
            } else {
                bootbox.alert({title: "é”™è¯¯æç¤º", message: "æ–‡ç« æ”¶è—å¤±è´¥,è¯·è”ç³»ç®¡ç†å‘˜"});
                // alert('"æ–‡ç« æ”¶è—å¤±è´¥,è¯·è”ç³»ç®¡ç†å‘˜"')
            }

        })
    }

    //å–æ¶ˆæ”¶è—
    function cancelFavorite(articleid) {
        var param = 'articleid=' + articleid;
        $.ajax({
            url: '/favorite/' + articleid,
            type: 'delete',
            success: function (data) {
                if (data == 'not-login') {
                    bootbox.alert({title: "é”™è¯¯æç¤º", message: "ä½ è¿˜æœªç™»å½•,è¯·å…ˆç™»å½•åå†å–æ¶ˆæ”¶è—"});
                    // alert('ä½ è¿˜æœªç™»å½•,è¯·å…ˆç™»å½•åå†å–æ¶ˆæ”¶è—æœ¬æ–‡')

                } else if (data == 'cancel-pass') {
                    bootbox.alert({title: "ä¿¡æ¯æç¤º", message: "æ–‡ç« å–æ¶ˆæ”¶è—æˆåŠŸ"});
                    // alert("æ–‡ç« å–æ¶ˆæ”¶è—æˆåŠŸ")
                    $(".favorite-btn").html('<span  aria-hidden="true" ></span>æ¬¢è¿å†æ¥');

                    $(".favorite-btn").attr('onclick', '').unbind('click');
                }
            }
        })
    }

    function addComment(articleid) {
        var content = $.trim($("#comment").val());
        if (content.length > 1000) {
            bootbox.alert({title: "é”™è¯¯æç¤º", message: "è¯„è®ºå†…å®¹ä¸èƒ½è¶…è¿‡1000ä¸ªå­—ç¬¦"});
            return false;
        }

        var param = 'articleid=' + articleid + '&content=' + content;
        $.post('/comment', param, function (data) {
            if (data == 'content-invalid') {
                bootbox.alert({title: "é”™è¯¯æç¤º", message: "è¯„è®ºå†…å®¹ä¸èƒ½è¶…è¿‡1000ä¸ªå­—ç¬¦"});
            } else if (data == 'add-pass') {
                location.reload();
            } else if (data == "not-login") {
                bootbox.alert({title: "é”™è¯¯æç¤º", message: "ä½ è¿˜æœªç™»å½•,è¯·å…ˆç™»å½•åå†è¯„è®º"});
            } else {
                bootbox.alert({title: "é”™è¯¯æç¤º", message: "è¯„è®ºå¤±è´¥,è¯·è”ç³»ç®¡ç†å‘˜"});
            }

        });
    }


    //é€šè¿‡ä»€ä¹ˆæ ·çš„æ–¹å¼æ¥ä¼ é€’commentidå‘¢ï¼Ÿ
    //1.ä½¿ç”¨å…¨å±€å˜é‡
    //2. ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶çš„DIVæˆ–éšè—çš„è¡¨å•å…ƒç´ åšä¸­è½¬ <div id='temp' style='display:none'>12345</div>

    var COMMENTID = 0;

    function gotoReply(commentid) {
        // alert(commentid)
        $("#submitBtn").hide();     // éšè—å‘è¡¨è¯„è®ºæŒ‰é’®
        $("#replyBtn").show();      // æ˜¾ç¤ºå›å¤è¯„è®ºæŒ‰é’®
        $("#nickname").val("è¯·åœ¨æ­¤å›å¤ç¼–å·ä¸º " + commentid + " çš„è¯„è®º");
        $("#comment").focus();      // è®©æ–‡æœ¬åŸŸè·å–ç„¦ç‚¹
        COMMENTID = commentid;  // ä¿®æ”¹å…¨å±€å˜é‡çš„å€¼ä¸ºå½“å‰è¢«å›å¤è¯„è®ºçš„iD
    }


    function hideComment(commentid) {
        var param = '&commentid=' + commentid
        $.post('/delete', param, function (data) {
            if (data == 'delete-pass') {
                location.reload();
            } else if (data == 'delete-fail') {
                bootbox.alert({title: "é”™è¯¯æç¤º", message: "éšè—è¯„è®ºå‡ºé”™ï¼Œè¯·è”ç³»ç®¡ç†å‘˜."});
            } else if (data == 'not-login') {
                bootbox.alert({title: "é”™è¯¯æç¤º", message: "ä½ è¿˜æœªç™»å½•,è¯·å…ˆç™»å½•åå†å›å¤"});
            }
        });
    }

    function replyComment(articleid) {
        var content = $.trim($("#comment").val());
        if (content.length > 1000) {
            bootbox.alert({title: "é”™è¯¯æç¤º", message: "è¯„è®ºå†…å®¹åœ¨1000å­—ä¹‹å†…."});
            return false;
        }
        var param = 'articleid=' + articleid;
        param += '&content=' + content;
        param += '&commentid=' + COMMENTID;
        $.post('/reply', param, function (data) {
            if (data == 'content-invalid') {
                bootbox.alert({title: "é”™è¯¯æç¤º", message: "è¯„è®ºå†…å®¹åœ¨1000å­—ä¹‹å†…."});
            } else if (data == 'reply-pass') {
                location.reload();
            } else if (data == 'reply-fail') {
                bootbox.alert({title: "é”™è¯¯æç¤º", message: "å›å¤è¯„è®ºå‡ºé”™ï¼Œè¯·è”ç³»ç®¡ç†å‘˜."});
            } else if (data == 'not-login') {
                bootbox.alert({title: "é”™è¯¯æç¤º", message: "ä½ è¿˜æœªç™»å½•,è¯·å…ˆç™»å½•åå†å›å¤"});
            }
        });
    }

    var PAGE = 1;   // å®šä¹‰å…¨å±€å˜é‡ç”¨äºè®°å½•å‰é¢åœ¨å“ªä¸€é¡µï¼Œé»˜è®¤åœ¨ç¬¬1é¡µ
    var TOTAL = '{{total}}'
    ;  // å®šä¹‰æ€»é¡µæ•°ï¼Œç”±æ¨¡æ¿å¼•æ“å…ˆå¼•å¡«å……

    // æ·»åŠ gotoPageå‡½æ•°å¯¹åº”çš„ä»£ç 
    function gotoPage(articleid, type) {
        // å¦‚æœå½“å‰é¢æ˜¯ç¬¬1é¡µï¼Œåˆ™ä¸Šä¸€é¡µè¿˜æ˜¯ç¬¬1é¡µ
        if (type == 'prev') {
            if (PAGE > 1)
                PAGE -= 1;
        }
        // å¦‚æœå½“å‰é¡µæ˜¯æ˜¯åä¸€é¡µï¼Œåˆ™ä¸‹ä¸€é¡µè¿˜æ˜¯æœ€åä¸€é¡µ
        else if (type == 'next') {
            if (PAGE < TOTAL)
                PAGE += 1;
        } else {
            PAGE = parseInt(type);
        }
        fillComment(articleid, PAGE);
    }


    // å¡«å……åˆ†é¡µè¯„è®ºæ•°æ®ï¼Œæ³¨æ„å…¶ä¸­çš„DOMå…ƒç´ çš„æ‹¼æ¥æ“ä½œ
    function fillComment(articleid, pageid) {
        $("#commentDIV").empty();   // å…ˆæ¸…ç©ºç°æœ‰è¯„è®ºåŒºå†…å®¹
        var content = '';           // ç”¨äºæ‹¼æ¥è¯„è®ºåŒºå…ƒç´ ä¸å†…å®¹
        $.get('/comment/' + articleid + '-' + pageid, function (data) {
            var comment = data;
            for (var i in comment) {
                content += '<div class="col-12 list row">';
                content += '<div class="col-2 icon">';
                content += '<a href="/home/' + comment[i]['userid'] + '"><img src="/chat_room/images/' + comment[i]['avatar'] + '" class="img-fluid" style="width: 70px;border-radius: 50%"/></a>';
                content += '</div>';
                content += '<div class="col-10 comment">';
                content += '<div class="col-12 row" style="padding: 0px;">';
                content += '<div class="col-7 commenter">';
                content += comment[i]['nickname'];
                content += '&nbsp;&nbsp;&nbsp;' + comment[i]['createtime'];
                content += '</div>';
                content += '<div class="col-5 reply">';
                <!-- æ–‡ç« ä½œè€…ã€ç®¡ç†å‘˜å’Œè¯„è®ºè€…åªèƒ½å›å¤å’Œéšè—ï¼Œä¸èƒ½ç‚¹èµ-->
                <!-- æ­¤å¤„çš„åˆ¤æ–­å†…å®¹ç”±æ¨¡æ¿å¼•æ“å…ˆè¡Œå¡«å……ï¼Œå­—ç¬¦ä¸²çš„æ¯”è¾ƒåœ¨å¤–é¢åŠ  "" -->
                if ("{{article.userid}}" == "{{session.get('userid')}}" ||
                    "{{session.get('role')}}" == "admin" ||
                    comment[i]['userid'] + "" == "{{session.get('userid')}}") {
                    content += '<label onclick="gotoReply(' + comment[i]['commentid'] + ')">';
                    content += '<span  aria-hidden="true"></span>';
                    content += 'â™»å›å¤</label>&nbsp;&nbsp;&nbsp;';
                    content += '<label onclick="hideComment( ' + comment[i]['commentid'] + ')">';
                    content += '<span  aria-hidden="true"></span>ğŸ—‘éšè—</label>';
                } else {
                    <!-- å…¶ä»–ç”¨æˆ·åªèƒ½å›å¤,ä¸èƒ½éšè— -->
                    content += '<label onclick="gotoReply(' + comment[i]['commentid'] + ')">';
                    content += '<span  aria-hidden="true"></span>â™»å›å¤';
                    content += '</label>&nbsp;&nbsp;';
                }
                content += '</div>';
                content += '</div>';
                content += '<div class="col-12 content">';
                content += comment[i]['content'];     <!-- å¡«å……åŸå§‹è¯„è®ºå†…å®¹ -->
                content += '</div>';
                content += '</div>';
                content += '</div>';

                <!-- åœ¨å½“å‰è¯„è®ºä¸‹æ–¹å¡«å……å›å¤è¯„è®º,å¦‚æœå½“å‰è¯„è®ºæœ‰å›å¤æ‰å¡«å…… -->
                if (comment[i]['reply_list'].length > 0) {
                    var reply = comment[i]['reply_list'];
                    for (var j in reply) {
                        content += '<div class="col-12 list row">';
                        content += '<div class="col-2 icon">';
                        content += '<a href="/home/' + reply[j]['userid'] + '"><img src="/chat_room/images/' + reply[j]['avatar'] + '" class="img-fluid" style="width: 50px; border-radius: 50%"/></a>';
                        content += '</div>';
                        content += '<div class="col-10 comment" style="border: solid 1px #ccc;">';
                        content += '<div class="col-12 row" style="padding-left: 50px;">';
                        content += '<div  class="col-7 commenter" style=" color: #ff0505">';
                        content += reply[j]['nickname'];
                        content += '&nbsp;&nbsp;å›å¤&nbsp;&nbsp;';
                        content += comment[i]['nickname'];
                        content += '&nbsp;&nbsp;&nbsp;';
                        content += reply[j]['createtime'];
                        content += '</div>';
                        content += '<div class="col-5 reply">';
                        if ("{{article.userid}}" == "{{session.get('userid')}}" ||
                            "{{session.get('role')}}" == "admin" ||
                            reply[j]['userid'] + "" == "{{session.get('userid')}}") {
                            content += '<label onclick="hideComment( ' + reply[j]['commentid'] + ')">';
                            content += '<span  aria-hidden="true"></span>ğŸ—‘éšè—';
                            content += '</label>&nbsp;&nbsp;&nbsp;';
                        }
                        content += '<label onclick="gotoReply(' + comment[i]['commentid'] + ')">';
                        content += '<span  aria-hidden="true"></span>â™»å›å¤';
                        content += '</label>&nbsp;&nbsp;';

                        content += '</div>';
                        content += '</div>';
                        content += '<div  class="col-12 content" style="padding-left: 50px;">';
                        content += reply[j]['content'];
                        content += '</div>';
                        content += '</div>';
                        content += '</div>';
                    }
                }
            }
            $("#commentDIV").html(content);    // å¡«å……åˆ°è¯„è®ºåŒºåŸŸ
        });
    }

    window.onload = function () {
        fillComment('{{article.articleid}}', '1');
    }




    $(function () {
        // åˆå§‹åŒ–æ‰€æœ‰å…³æ³¨æŒ‰é’®çš„çŠ¶æ€
        $('.btn-follow').each(function () {
            var $btn = $(this);
            var followed_vip_id = $btn.data('followed-vip-id');
            var isFollowing = localStorage.getItem('follow_' + followed_vip_id + '_switch');

            if (isFollowing === 'true') {
                $btn.addClass('following').text('å–æ¶ˆå…³æ³¨');
            } else {
                $btn.removeClass('following').text('å…³æ³¨');
            }
        });

        // å…³æ³¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $('.btn-follow').on('click', function () {
            var $btn = $(this);
            var followed_vip_id = $btn.data('followed-vip-id');

            if ($btn.hasClass('following')) {
                // å–æ¶ˆå…³æ³¨
                $.ajax({
                    url: '/home/unfollow',
                    type: 'POST',
                    data: {followed_vip_id: followed_vip_id},
                    success: function (response) {
                        if (response === 'success') {

                            // alert('å–æ¶ˆå…³æ³¨æˆåŠŸï¼');
                            bootbox.alert({'title': 'ä¿¡æ¯æç¤ºï¼', 'message': "å–æ¶ˆå…³æ³¨æˆåŠŸï¼"});

                            $btn.removeClass('following').text('å…³æ³¨');
                            localStorage.setItem('follow_' + followed_vip_id + '_switch', 'false');
                        } else {
                            // alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                            bootbox.alert({'title': 'é”™è¯¯æç¤ºï¼', 'message': "æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•ï¼"});

                        }
                    },
                    error: function () {
                        // alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                        bootbox.alert({'title': 'é”™è¯¯æç¤ºï¼', 'message': "æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•ï¼"});

                    }
                });
            } else {
                // è¿›è¡Œå…³æ³¨
                $.ajax({
                    url: '/home/follow',
                    type: 'POST',
                    data: {followed_vip_id: followed_vip_id},
                    success: function (response) {
                        if (response === 'success') {
                            // alert('å…³æ³¨æˆåŠŸï¼');
                            bootbox.alert({'title': 'ä¿¡æ¯æç¤ºï¼', 'message': "å…³æ³¨æˆåŠŸï¼"});

                            $btn.addClass('following').text('å–æ¶ˆå…³æ³¨');
                            localStorage.setItem('follow_' + followed_vip_id + '_switch', 'true');
                        } else {
                            // alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                            bootbox.alert({'title': 'é”™è¯¯æç¤ºï¼', 'message': "æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•ï¼"});

                        }
                    },
                    error: function () {
                        // alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                        bootbox.alert({'title': 'é”™è¯¯æç¤ºï¼', 'message': "æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•ï¼"});

                    }
                });
            }
        });
    });

</script>


{% endblock %}